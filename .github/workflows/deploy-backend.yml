name: Deploy Backend (Django) to Azure App Service

on:
  push:
    branches: [ stage ]        # o main, ajusta a tu flujo
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Cambia esta ruta si tu backend está en otra carpeta
      - name: Empaquetar backend (ZipDeploy)
        run: |
          set -e
          BACKEND_DIR="proyecto_bia"
          cd "$BACKEND_DIR"

          # Verificación mínima (manage.py + requirements.txt)
          test -f manage.py
          test -f requirements.txt

          # El zip debe tener manage.py y requirements.txt en la RAÍZ del paquete
          zip -r ../backend.zip \
            manage.py requirements.txt proyecto_bia certificado_ldd carga_datos \
            -x "**/__pycache__/*" "**/*.pyc" ".git/*" "*.zip" "media/*" "staticfiles/*"

          cd -

      - name: Deploy to Azure Web App (ZipDeploy)
        uses: azure/webapps-deploy@v2
        with:
          app-name: backend-grupobia
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
          package: backend.zip
